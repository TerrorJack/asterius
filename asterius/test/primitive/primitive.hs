import Data.Primitive.ByteArray
import Data.Word

main :: IO ()
main = do
  -- ---------------------------------------------------------------------
  -- MEMSET (setByteArray uses memset internally)
  -- ---------------------------------------------------------------------
  dst <- newPinnedByteArray 32
  unfreezeAndPrint "0: " dst
  -- Expected:
  -- 0: [0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0]

  setByteArray dst 0 1 (0xeeeeeeee :: Word32)
  setByteArray dst 4 2 (0xff1234ff :: Word32)
  unfreezeAndPrint "1: " dst
  -- Expected:
  -- 1: [0xee, 0xee, 0xee, 0xee, 0xff, 0x34, 0x12, 0xff, 0xff, 0x34, 0x12, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0]

  setByteArray dst 2 2 (0x1122 :: Word16)
  unfreezeAndPrint "2: " dst
  -- Expected:
  -- 2: [0xee, 0xee, 0x22, 0x11, 0x22, 0x11, 0x12, 0xff, 0xff, 0x34, 0x12, 0xff, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0]

  -- setByteArray dst 24 1 (0xcccccccccccccccc :: Word64)
  -- unfreezeAndPrint "3: " dst
  -- -- THROWS THIS AT ME:
  -- --
  -- -- ==>> TypeError: Cannot convert 0 to a BigInt
  -- -- ==>>     at BigUint64Array.fill (<anonymous>)
  -- -- ==>>     at Memory.memset (file:///home/skull/tweag/asterius/asterius/test/primitive/rts.memory.mjs:311:9)
  -- -- ==>>     at wasm-function[2780]:0x950e1
  -- -- ==>>     at wasm-function[37]:0x3466
  -- -- ==>>     at wasm-function[3056]:0x9ff0c
  -- -- ==>>     at wasm-function[3057]:0x9ff39
  -- -- ==>>     at Scheduler.tick (file:///home/skull/tweag/asterius/asterius/test/primitive/rts.scheduler.mjs:347:22)
  -- -- ==>>     at Immediate.<anonymous> (file:///home/skull/tweag/asterius/asterius/test/primitive/rts.scheduler.mjs:382:29)
  -- -- ==>>     at processImmediate (internal/timers.js:456:21)

  where
    unfreezeAndPrint s ba =
      unsafeFreezeByteArray ba >>= \a -> putStr s >> print a


